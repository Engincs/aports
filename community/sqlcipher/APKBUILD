# Contributor: wener <wenermail@gmail.com>
# Maintainer: lauren n. liberda <lauren@selfisekai.rocks>
pkgname=sqlcipher
pkgver=4.11.0
pkgrel=0
pkgdesc="SQLCipher is an SQLite extension that provides 256 bit AES encryption of database files."
url="https://www.zetetic.net/sqlcipher/"
arch="all"
license="BSD-3-Clause"
makedepends="openssl-dev>3 tcl-dev readline-dev zlib-dev"
subpackages="
	$pkgname-dbg
	$pkgname-dev
	$pkgname-doc
	$pkgname-libs
	$pkgname-tcl
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/sqlcipher/sqlcipher/archive/v$pkgver.tar.gz"

prepare() {
	default_prepare
}

build() {
	export CFLAGS="$CFLAGS \
		-DSQLITE_HAS_CODEC \
		-DSQLCIPHER_TEST \
		-DSQLITE_ENABLE_COLUMN_METADATA \
		-DSQLITE_ENABLE_UPDATE_DELETE_LIMIT \
		-DSQLITE_ENABLE_FTS3_PARENTHESIS \
		-DSQLITE_SECURE_DELETE \
		-DSQLITE_ENABLE_UNLOCK_NOTIFY \
		-DSQLITE_ENABLE_RTREE \
		-DSQLITE_ENABLE_GEOPOLY \
		-DSQLITE_USE_URI \
		-DSQLITE_ENABLE_DBSTAT_VTAB \
		-DSQLITE_MAX_VARIABLE_NUMBER=250000 \
		-DSQLITE_EXTRA_INIT=sqlcipher_extra_init \
		-DSQLITE_EXTRA_SHUTDOWN=sqlcipher_extra_shutdown \
		-DSQLITE_TEMP_STORE=2 \
		"
	export LDFLAGS="$LDFLAGS -lcrypto"

	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--fts5

	make
}

check() {
	make testfixture
	./testfixture test/sqlcipher.test
}

package() {
	make DESTDIR="$pkgdir" install

	install -Dm0644 sqlcipher.1 \
		"$pkgdir"/usr/share/man/man1/sqlcipher.1
}

tcl() {
	pkgdesc="SQLCipher library (tcl bindings)"

	amove usr/lib/tcl*
}

sha512sums="
5b5f160a581d6b6822d0bda3a7401a0f82c814c0ef974f6c87b851ebdaac68eb610812dec859529f6798ed444fa8d9f4493ea12f9c26535fa54cdf698dca75a8  sqlcipher-4.11.0.tar.gz
"

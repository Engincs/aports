# Contributor: Marian Buschsieweke <marian.buschsieweke@posteo.net>
# Maintainer: Marian Buschsieweke <marian.buschsieweke@posteo.net>
pkgname=opencascade
pkgver=7.9.2
pkgrel=0
pkgdesc="SDK for development of applications dealing with 3D CAD data"
url="https://dev.opencascade.org/"
# s390x blocked by vtk -> netcdf
arch="all !s390x"
license="LGPL-2.1-only"
makedepends="
	cmake
	doxygen
	freeimage-dev
	freetype-dev
	libxi-dev
	libxmu-dev
	mesa-dev
	qt5-qtbase-dev
	rapidjson-dev
	samurai
	tk-dev
	vtk-dev
	"
subpackages="$pkgname-doc $pkgname-dev"
source="$pkgname-$pkgver.tar.gz::https://github.com/Open-Cascade-SAS/OCCT/archive/refs/tags/V${pkgver//./_}.tar.gz
	no_mallinfo.patch
	no_feenableexcept.patch
	no_backtrace.patch
	"
builddir="$srcdir/OCCT-${pkgver//./_}"
options="!check" # No tests provided :-/

build() {
	# Disabling ffmpeg for now, as VTK already uses ffmpeg in version 5, while OCC only
	# builds with ffmpeg4 right now. vtk-dev depends on ffmpeg-dev which conflics with
	# ffmpeg4-dev. Once patched to build with ffmpeg-dev (not ffmpeg4-dev), ffmpeg support
	# should be re-enabled.
	# Targeted for v8.0.0: https://github.com/Open-Cascade-SAS/OCCT/pull/582
	#
	# Detecting TBB is broken, we disable it for now.
	cmake -B build -G Ninja -Wno-dev \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DUSE_FFMPEG=OFF \
		-DUSE_FREEIMAGE=ON \
		-DUSE_RAPIDJSON=ON \
		-DUSE_TBB=OFF \
		-DUSE_VTK=ON \
		-D3RDPARTY_VTK_INCLUDE_DIR=/usr/include/vtk-9.3/
	cmake --build build
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	# Fix broken cmake files
	find "$pkgdir"/usr/lib/cmake/opencascade -type f -exec \
		sed -i {} -e 's/\${OCCT_INSTALL_BIN_LETTER}//g' \;
}

sha512sums="
58f9ab91c5119e0a99fb7599bce574f17ce3e3a802a9c503fa0464228d5b2141e3f5557ef68355b4921b572bd10d99bec0f31836a103d5e5fa98cd0d685610a2  opencascade-7.9.2.tar.gz
a81e5dd1c594a8c58854846d824c1d96e11391301e44196169157cef2d921f26d051b258f88e3f0081e98be1e156264ad7818625346b17305c0a23f42eb4694c  no_mallinfo.patch
ccb25d209d3edec66e93b5ce6227f2fe357400c01c76aea3b7f074b49a530637c74c953222196a5ea5577d3630f7d40ed57d1cc2ffda74e86fe37427cccd16c2  no_feenableexcept.patch
6ddd5ead0dfca2fa6bf003ac6988a8b69a811b8015d5061f40983febc990708d056bb18582a8c87725293a3d0536bf120286a99915442e31238e93205b89603b  no_backtrace.patch
"

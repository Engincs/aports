# Contributor: Nulo <alpine@nulo.in>
# Maintainer: Adam Thiede <me@adamthiede.com>
pkgname=coreboot-tools
pkgver=25.09
pkgrel=0
pkgdesc="Tools from the coreboot project"
url="https://review.coreboot.org/coreboot"
arch="all"
license="GPL-2.0-only"

makedepends="
	inkscape
	meson
	pciutils-dev
	qt5-qtbase-dev
	qt5-qttools-dev
	qt5-qtsvg-dev
	yaml-cpp-dev
	zlib-dev
	"
subpackages="$pkgname-ifdtool $pkgname-cbmem"
case "$CARCH" in
	# memcpy is out of bounds on x86
	aarch64|x86_64) subpackages="$subpackages $pkgname-cbfstool" ;;
esac
case "$CARCH" in
	x86*) subpackages="$subpackages $pkgname-ectool $pkgname-intelmetool $pkgname-nvramtool $pkgname-nvramtool-doc:nvramtool_doc:noarch $pkgname-configurator" ;;
esac

source="
https://coreboot.org/releases/coreboot-$pkgver.tar.xz
musl.patch
"
builddir="$srcdir/coreboot-$pkgver"
options="!check" # no test suite

package() {
	mkdir -p "$pkgdir"
}

intelmetool() {
	pkgdesc="Dump interesting things about Management Engine"

	make -C "$builddir"/util/intelmetool CFLAGS+="-I $builddir/src/commonlib/bsd/include"
	make -e -C "$builddir"/util/intelmetool PREFIX="$subpkgdir/usr" install
}

nvramtool() {
	pkgdesc="Manipulates NVRAM from userspace"

	make -e -C "$builddir"/util/nvramtool CFLAGS="$CFLAGS -I. -DCMOS_HAL=1"
	make -e -C "$builddir"/util/nvramtool PREFIX="$subpkgdir/usr" install
	gzip -9n "$subpkgdir"/usr/share/man/man8/*
}

nvramtool_doc() {
	pkgdesc="Manipulates NVRAM from userspace (documentation)"
	install_if="$pkgname-nvramtool=$pkgver-r$pkgrel docs"

	mkdir -p "$subpkgdir"/usr/share/
	mv "$pkgdir"/../"$pkgname-nvramtool"/usr/share/man "$subpkgdir"/usr/share/
}

ectool() {
	pkgdesc="Dumps the RAM of a laptopâ€™s Embedded/Environmental Controller (EC)"

	make -e -C "$builddir"/util/ectool
	make -e -C "$builddir"/util/ectool PREFIX="$subpkgdir/usr" install
}

ifdtool() {
	pkgdesc="Extract and dump Intel Firmware Descriptor information"

	make -e -C "$builddir"/util/ifdtool
	make -e -C "$builddir"/util/ifdtool PREFIX="$subpkgdir/usr" install
}

cbmem() {
	pkgdesc="CBMEM parser to read e.g. timestamps and console log"

	make -e -C "$builddir"/util/cbmem
	make -e -C "$builddir"/util/cbmem PREFIX="$subpkgdir/usr" install
}

configurator() {
	pkgdesc="Graphical NVRAMtool frontend"
	abuild-meson -Db_lto=true "$builddir"/util/coreboot-configurator "$builddir"/util/coreboot-configurator/output
	meson compile -C "$builddir"/util/coreboot-configurator/output
	DESTDIR="$subpkgdir" meson install --no-rebuild -C $builddir/util/coreboot-configurator/output
}

cbfstool() {
	pkgdesc="Management utility for CBFS formatted ROM images"

	make -e -C "$builddir"/util/cbfstool cbfstool
	make -e -C "$builddir"/util/cbfstool cbfstool PREFIX="$subpkgdir/usr" install
}

sha512sums="
5b602372d0760ace735fb47e61c57aeba92a7b4ce2eb4ccd740aae4d9bfd5ce97937f75073c9fde4f00d30b65e6e0a5387e00c319277931a1bea04de57884af7  coreboot-25.09.tar.xz
c2d2683168626c562f4c0e9fed4bb71701b14d12d0ea3726c43cda707dd882709492a9c59465d09de294e06f75888f888c50e982bdf32c78fc8a708432ed0aec  musl.patch
"

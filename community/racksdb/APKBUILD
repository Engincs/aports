# Maintainer: omni <omni+alpine@hack.org>
maintainer="omni <omni+alpine@hack.org>"
pkgname=racksdb
pkgver=0.5.0
pkgrel=0
pkgdesc="YAML-based database of datacenter infrastructures"
url="https://rackslab.io/en/solutions/racksdb/"
arch="noarch"
license="GPL-3.0-or-later"
depends="py3-$pkgname=$pkgver-r$pkgrel"
_pydepends="python3
	pango
	py3-clustershell
	py3-cairo
	py3-gobject3
	py3-pyaml
	py3-rfl-log
	"
_webdepends="py3-flask
	py3-requests-toolbelt
	"
makedepends="asciidoctor npm py3-gpep517 py3-setuptools py3-wheel"
checkdepends="$_pydepends
	$_webdepends
	py3-parameterized
	py3-pytest
	py3-pytest-cov
	py3-werkzeug
	"
subpackages="$pkgname-doc
	py3-$pkgname-web-pyc:_py3_web_pyc
	py3-$pkgname-web:_py3_web
	py3-$pkgname-pyc
	py3-$pkgname:_py3
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/rackslab/RacksDB/archive/refs/tags/v$pkgver.tar.gz
	frontend-npm-audit.patch
	"
builddir="$srcdir/RacksDB-$pkgver"
options="net" # npm

case "$CARCH" in
loongarch64|ppc64le|s390x|x86)
	# https://github.com/rollup/rollup/pull/5997
	;;
*)
	subpackages="$subpackages $pkgname-web:_web"
	;;
esac

prepare() {
	default_prepare

	case "$CARCH" in
	loongarch64|ppc64le|s390x|x86) ;;
	*)
		cd frontend
		npm ci --foreground-scripts
		;;
	esac
}

build() {
	gpep517 build-wheel --wheel-dir .dist --output-fd 3 3>&1 >&2

	for adocman in docs/man/*.adoc; do
		asciidoctor --backend manpage --attribute mansource='RacksDB 0.4.0' "$adocman"
	done

	case "$CARCH" in
	loongarch64|ppc64le|s390x|x86) ;;
	*)
		cd frontend
		npm run build
		;;
	esac
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest

	case "$CARCH" in
	loongarch64|ppc64le|s390x|x86) ;;
	*)
		cd frontend
	# check for vulnerabilities, some fixes may have breaking changes and need
	# to be handled with care, only fail on Severity: high, TODO: change this
		npm audit --audit-level=high
		;;
	esac
}

package() {
	python3 -m installer -d "$pkgdir" .dist/*.whl
	rm -r "$pkgdir"/usr/lib/python3.*/site-packages/"$pkgname"/tests

	case "$CARCH" in
	loongarch64|ppc64le|s390x|x86) ;;
	*)
		install -dm0755 "$pkgdir"/usr/share/"$pkgname"/frontend
		cp -r frontend/dist/* \
			"$pkgdir"/usr/share/"$pkgname"/frontend/
		;;
	esac

	install -Dm0644 schemas/* \
		-t "$pkgdir"/usr/share/"$pkgname"/schemas/

	install -dm0755 "$pkgdir"/etc/"$pkgname"

	install -Dm0644 docs/man/*.1 -t "$pkgdir"/usr/share/man/man1/
	install -Dm0644 CHANGELOG.md -t "$pkgdir"/usr/share/doc/"$pkgname"/
	cp -r examples "$pkgdir"/usr/share/doc/"$pkgname"/
	install -Dm0644 docs/modules/db/examples/*yml \
		-t "$pkgdir"/usr/share/doc/"$pkgname"/examples/db/
	install -Dm0644 docs/modules/usage/examples/custom.* \
		-t "$pkgdir"/usr/share/doc/"$pkgname"/examples/
}

_web() {
	depends="py3-$pkgname-web=$pkgver-r$pkgrel"
	pkgdesc="$pkgname Web UI"

	amove usr/bin/racksdb-web
	amove usr/share/racksdb/frontend
}

_py3_web_pyc() {
	pkgdesc="Precompiled Python bytecode for ${subpkgname%-pyc}"
	install_if="${subpkgname%-pyc}=$pkgver-r$pkgrel pyc"

	amove usr/lib/python3*/site-packages/racksdb/web/__pycache__
}

_py3_web() {
	depends="$_webdepends
		py3-$pkgname=$pkgver-r$pkgrel
		"
	pkgdesc="$pkgname Web UI python3 bindings"

	amove usr/lib/python3*/site-packages/racksdb/web
}

_py3() {
	depends="$_pydepends"
	pkgdesc="$pkgname python3 bindings"

	amove usr/lib/python3*
}

sha512sums="
16fa8e76f9fe7fcfc9ed5385f6e9301e1e6aafb3e5cdd5cea175715a4e98cc01d314e74fa57c03f60e2f2b12eb81c319a2071ba745c46e6ef49e068c4f17b688  racksdb-0.5.0.tar.gz
6489e2361a5e2de99a6e2ef646705925dbc139cc7d4e9d1446e88d582c3e658bc2f76daa1b0e2a8c4f6cda1d44a014731a0ed13fbd7b31c990e005fb7659440c  frontend-npm-audit.patch
"

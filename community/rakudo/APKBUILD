# Contributor: Curt Tilmes <Curt.Tilmes@nasa.gov>
# Maintainer: Curt Tilmes <Curt.Tilmes@nasa.gov>
pkgname=rakudo
pkgver=2025.08
pkgrel=0
pkgdesc="Compiler for the Raku programming language"
url="https://rakudo.org/"
arch="all"
license="Artistic-2.0"
depends="nqp~$pkgver"
makedepends="
	moarvm-dev~$pkgver
	perl-utils
	"
checkdepends="perl-test-harness"
subpackages="$pkgname-dev $pkgname-doc"
_nqp_configure=566ca585735e9dc5abe0f0cf40e1f9912b69c693
source="https://github.com/rakudo/rakudo/archive/refs/tags/$pkgver/rakudo-$pkgver.tar.gz
	https://github.com/Raku/nqp-configure/archive/$_nqp_configure/nqp-configure-$_nqp_configure.tar.gz
	telemetry-tests-32bit.patch
	"

prepare() {
	rmdir -v 3rdparty/nqp-configure
	mv -v "$srcdir"/nqp-configure-$_nqp_configure \
		3rdparty/nqp-configure

	default_prepare
}


build() {
	perl Configure.pl \
		--prefix=/usr \
		--backends=moar \
		--rakudo-home=/usr/share/"$pkgname"
	make
}

check() {
	export RAKUDO_RUN_TIMING_TESTS=0
	export ROAST_TIMING_SCALE=15
	export TEST_JOBS=$JOBS
	export HARNESS_VERBOSE=1
	export CARCH

	msg "Running $TEST_JOBS parallel test jobs"
	make test
}

package() {
	make DESTDIR="$pkgdir" install
	ln -sv rakudo "$pkgdir"/usr/share/perl6

	install -Dvm644 CONTRIBUTING.md CREDITS \
		LICENSE README.md VERSION \
		-t "$pkgdir"/usr/share/doc/"$pkgname"
	cp -vr docs "$pkgdir"/usr/share/doc/"$pkgname"/
}

dev() {
	default_dev

	amove	usr/bin/perl6-debug* usr/bin/perl6-gdb-m \
		usr/bin/perl6-lldb-m usr/bin/perl6-valgrind-m \
		usr/bin/rakudo-debug* usr/bin/rakudo-gdb-m \
		usr/bin/rakudo-lldb-m usr/bin/rakudo-valgrind-m \
		usr/bin/raku-debug

	mkdir -vp "$subpkgdir"/usr/share/"$pkgname"
	cp -vr "$builddir"/tools "$subpkgdir"/usr/share/"$pkgname"/
}

sha512sums="
34a3a62ed1277a588732f682ad10cfd9769b5544ae955dbed053cc2db0e56ffeb3f476f07d8bfe8c9dbcf17b2719b67cdaece609dd3d8e47ac1d4b5f29376111  rakudo-2025.08.tar.gz
50da48eb427ea0a848b297744c77d288d2fe644b35f7c157f18ec3094fe47b7d679616470dc1aa79b072429bb346f8249adf4dabb06366007f988c2c84c056c5  nqp-configure-566ca585735e9dc5abe0f0cf40e1f9912b69c693.tar.gz
1881c8e3e4ad956ba26dbbb0c818b4f26d39c8582bd2f47cc92ebb10620f0ed0803b5619a8a281350d6aceeadfb88675eca59cf52701c837ca20e966daa5deb3  telemetry-tests-32bit.patch
"

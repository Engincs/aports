maintainer="Michał Polański <michal@polanski.me>"
pkgname=uvicorn
pkgver=0.38.0
pkgrel=0
pkgdesc="Lightning-fast ASGI server"
url="https://www.uvicorn.dev/"
license="BSD-3-Clause"
arch="noarch"
depends="py3-click py3-h11"
makedepends="py3-gpep517 py3-hatchling"
checkdepends="
	py3-a2wsgi
	py3-dotenv
	py3-httptools
	py3-httpx
	py3-pytest
	py3-pytest-mock
	py3-pytest-xdist
	py3-trustme
	py3-typing-extensions
	py3-watchfiles
	py3-websockets
	py3-wsproto
	py3-yaml
	"
subpackages="$pkgname-pyc"
source="https://github.com/Kludex/uvicorn/archive/$pkgver/uvicorn-$pkgver.tar.gz
	test_multiprocess.patch
	deprecations.patch
	"

build() {
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m pytest \
		-k "not test_send_binary_data_to_server_bigger_than_default_on_websockets"
}

package() {
	python3 -m installer -d "$pkgdir" \
		.dist/uvicorn-$pkgver-py3-none-any.whl
}

sha512sums="
f6f7c5670b99ba5b7c359af1b6bd42970953c87ada80695b052c7875b2f05e07a5c52683cd006028d38993cadd05bf9495a8983aea51930ed3380452941b8e37  uvicorn-0.38.0.tar.gz
cfad91dd84f8974362f52d754d7a29f09d07927a46acaa0eb490b6115a5729d84d6df94fead10ccd4cce7f5ea376f1348b0f59daede661dd8373a3851c313c46  test_multiprocess.patch
23b8eb6957cac206edfea4884a130a69e3c5598dd58986f19e1b65f111b0502a207cb78e45e6d62b54c83df1a5fa2d63fb80a4df303b56c5f1fa414d9d45bc25  deprecations.patch
"

# Contributor: Will Sinatra <wpsinatra@gmail.com>
# Contributor: Daniel Fancsali <fancsali@gmail.com>
# Maintainer: Will Sinatra <wpsinatra@gmail.com>
pkgname=clojure
pkgver=1.12.2
_tools="$pkgver.1565"
pkgrel=0
pkgdesc="The Clojure Programming Language"
url="https://clojure.org"
arch="noarch"
license="EPL-1.0"
case "$CARCH" in
	armhf|armv7|x86)	_jdkbuild=8	;;
	*)			_jdkbuild=21	;;
esac
depends="bash java-jdk rlwrap"
makedepends="maven openjdk$_jdkbuild-jdk"
subpackages="$pkgname-doc"
source="https://github.com/clojure/clojure/archive/clojure-$pkgver.tar.gz
	https://download.clojure.org/install/clojure-tools-$_tools.tar.gz
	"
builddir="$srcdir/clojure-clojure-$pkgver"
options="!check" # Check occurs in build

# secfixes:
#   1.11.2-r0:
#     - CVE-2024-22871

prepare() {
	default_prepare

	cd "$srcdir"/clojure-tools
	sed -i '/^bin_dir=BINDIR$/s/BINDIR/\/usr\/bin/' clj
	sed -i '/^install_dir=PREFIX$/s/PREFIX/\/usr\/share\/clojure/' clojure
	echo 'export CLOJURE_HOME=/usr/share/clojure' > clojure.sh
}

build() {
	export JAVA_HOME="/usr/lib/jvm/java-${_jdkbuild%%-*}-openjdk"

	mvn -Plocal package
}

package() {
	local sharedir="$pkgdir/usr/share/clojure"

	install -Dvm644 clojure.jar -t "$sharedir"/

	cd "$srcdir"/clojure-tools
	install -Dvm644 ./*.edn -t "$sharedir"/
	install -Dvm644 ./*.jar -t "$sharedir"/libexec/
	install -Dvm755 clj clojure -t "$pkgdir"/usr/bin/
	install -Dvm644 clojure.sh -t "$pkgdir"/etc/profile.d/
	install -Dvm644 ./*.1 -t "$pkgdir"/usr/share/man/man1/
}

sha512sums="
cc77e6e6bd8dccab6d050b7e85227c73582744adcbbaa2fd233c61f691b2b45cac91f3d37ebfcf2b69c5abf3e885fc43480c6630f0f5ba51f1da6de931cd720c  clojure-1.12.2.tar.gz
59eb557cfba9d61d9f6c10a5e5274fe827c1a7a39a9cb8ee44a50ff77841c08ce98310e4d4a5d922bd2997a4b160e91d02e615facc2f7498cc4433f040662739  clojure-tools-1.12.2.1565.tar.gz
"

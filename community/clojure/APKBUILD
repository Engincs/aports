# Contributor: Will Sinatra <wpsinatra@gmail.com>
# Contributor: Daniel Fancsali <fancsali@gmail.com>
# Maintainer: Will Sinatra <wpsinatra@gmail.com>
pkgname=clojure
pkgver=1.12.1
_tools="$pkgver.1561"
pkgrel=1
pkgdesc="The Clojure Programming Language"
url="https://clojure.org"
arch="noarch"
license="EPL-1.0"
case "$CARCH" in
	armhf|armv7|x86)	_jdkbuild=8	;;
	*)			_jdkbuild=21	;;
esac
depends="bash java-jdk rlwrap"
makedepends="maven openjdk$_jdkbuild-jdk"
subpackages="$pkgname-doc"
source="https://github.com/clojure/clojure/archive/clojure-$pkgver.tar.gz
	https://download.clojure.org/install/clojure-tools-$_tools.tar.gz
	"
builddir="$srcdir/clojure-clojure-$pkgver"
options="!check" # Check occurs in build

# secfixes:
#   1.11.2-r0:
#     - CVE-2024-22871

prepare() {
	default_prepare

	cd "$srcdir"/clojure-tools
	sed -i '/^bin_dir=BINDIR$/s/BINDIR/\/usr\/bin/' clj
	sed -i '/^install_dir=PREFIX$/s/PREFIX/\/usr\/share\/clojure/' clojure
	echo 'export CLOJURE_HOME=/usr/share/clojure' > clojure.sh
}

build() {
	export JAVA_HOME="/usr/lib/jvm/java-${_jdkbuild%%-*}-openjdk"

	mvn -Plocal package
}

package() {
	local sharedir="$pkgdir/usr/share/clojure"

	install -Dvm644 clojure.jar -t "$sharedir"/

	cd "$srcdir"/clojure-tools
	install -Dvm644 ./*.edn -t "$sharedir"/
	install -Dvm644 ./*.jar -t "$sharedir"/libexec/
	install -Dvm755 clj clojure -t "$pkgdir"/usr/bin/
	install -Dvm644 clojure.sh -t "$pkgdir"/etc/profile.d/
	install -Dvm644 ./*.1 -t "$pkgdir"/usr/share/man/man1/
}

sha512sums="
e9401501925f4e36ca1177a2aa4579c804acfbe59afc8d10069639bf99ae429d72037700503188c98117bff1eb51db8641d5dd5c2abf9bbc383a067a1be67bf9  clojure-1.12.1.tar.gz
c388f48fafd8b111600ebd874553f74b19d08034918b3b7f32298387eeb7b0b76bf5a5ab8ef7e1d86b41af85fd600282418154b297cc2754696c05f98a222a54  clojure-tools-1.12.1.1561.tar.gz
"

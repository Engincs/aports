# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=arturo
pkgver=0.9.84_alpha3392
_gitrev=b5862e1c7bfaf3b55a05ca4072a4a77db1ac7e3c
pkgrel=0
pkgdesc="Simple, expressive & portable programming language for efficient scripting"
url="https://arturo-lang.io/"
# s390x: nim unavailable, 32-bit: unhandled exception "division by zero"
arch="all !s390x !armhf !armv7 !x86"
license="MIT"
depends="so:libpcre.so.1"
makedepends="
	gmp-dev
	mpfr-dev
	nim
	openssl-dev
	pcre-dev
	sqlite-dev
	webkit2gtk-4.1-dev
	"
subpackages="$pkgname-doc $pkgname-full"
source="https://github.com/arturo-lang/arturo/archive/$_gitrev/arturo-$_gitrev.tar.gz
	compiler.patch
	openssl.patch
	prctl.patch
	"
builddir="$srcdir/$pkgname-$_gitrev"

build() {
	./build.nims -l -m full --as arturo-full --release
	./build.nims -l -m mini --as arturo --release
}

check() {
	[ "$(./bin/arturo-full tests/web/hello.art)" = "Hello world" ]
	[ "$(./bin/arturo tests/web/hello.art)" = "Hello world" ]
}

package() {
	install -Dvm755 bin/arturo -t "$pkgdir"/usr/bin/

	mkdir -p "$pkgdir"/usr/share/doc/$pkgname
	cp -R examples "$pkgdir"/usr/share/doc/$pkgname/
	install -Dvm644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
}

full() {
	pkgdesc="$pkgdesc (full variant)"
	depends="
		$depends
		so:libsqlite3.so.0
		so:libcrypto.so.3
		so:libssl.so.3
		"
	provides="arturo=0"
	replaces="arturo"

	install -Dvm755 "$builddir"/bin/arturo-full \
		"$subpkgdir"/usr/bin/arturo
}

sha512sums="
31f9714d8b3ca12dcf07b764a21210dca7d9db9456e11d5cd6d7219e9a7e27d6450a5bd5fcae43dfbd27490cc4a9b3a34589bb25a3fa7dd0f0cf754f0afa8f6f  arturo-b5862e1c7bfaf3b55a05ca4072a4a77db1ac7e3c.tar.gz
c01cc375c2074b34b4d39b5a53303df6dd28393169baa8f15284f4adb2e5d1f4f5a33ed8012a52f831710b4281a9c31a5aa4119a98e03a6cc0e40b4343a7b211  compiler.patch
4a6c08c5b00d545636d98081668536c20e9fd2b92fe209bc8ad3eee3354cda405b0e3030ca79c51008dbeecbef2e955f9bb462b34419f6534ee997d896053d2d  openssl.patch
b47f68736ed7684fce43b016c47de19afa3efd50a5e66e2c9979575048b77ef91536d7b218249b0b662120753ac37966306c02ea1b9556b86226c67f1484e142  prctl.patch
"

# Contributor: Aiden Grossman <agrossman154@yahoo.com>
# Maintainer:
pkgname=gmsh
pkgver=4.15.0
pkgrel=0
pkgdesc="Automatic 3D finite element mesh generator"
url="https://gmsh.info/"
# s390x: opencascade
# armv7, armhf: segfaults
# x86: fails tests
arch="all !x86 !armv7 !armhf !s390x"
license="GPL-2.0-or-later" # license lists several exceptions
makedepends="
	chrpath
	cmake
	fltk-dev
	glu-dev
	gmp-dev
	hdf5-dev
	jpeg-dev
	mesa-dev
	opencascade-dev
	samurai
	"
subpackages="$pkgname-dbg $pkgname-doc gmsh-py:py:noarch"
source="
	https://gmsh.info/src/gmsh-$pkgver-source.tgz
	"
builddir="$srcdir/$pkgname-$pkgver-source"

build() {
	CFLAGS="$CFLAGS -O2" \
	CXXFLAGS="$CXXFLAGS -O2" \
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr
	cmake --build build
}

check() {
	ctest --test-dir build
}

package() {
	DESTDIR="$pkgdir" cmake --install build

	# Drop redundant /usr/lib from rpath
	chrpath -d "$pkgdir"/usr/bin/gmsh
}

py() {
	depends="$pkgname=$pkgver-r$pkgrel python3"
	amove usr/bin/onelab.py
}

sha512sums="
f757688ed08b0c37ad3ebcf98b7661c385a434f83672fcad9c7f406afecc00fb1df6ef955a7ac76e54662ef95bcf2ca8a5d133c02603122ba5507f2d5359674e  gmsh-4.15.0-source.tgz
"

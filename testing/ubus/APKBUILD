# Maintainer: yurenchen <yurenchen@yeah.net>
pkgname=ubus
pkgver=2025.05.16  # from OpenWrt 24.10
pkgrel=0
_owrtgit=88e63250
pkgdesc="OpenWrt RPC daemon and utils"
url="https://git.openwrt.org/project/ubus.git"
arch="all"
license="LGPL-2.1-only"

depends_dev="libubox-dev"
makedepends="cmake samurai zstd json-c-dev libblobmsg $depends_dev"
subpackages="$pkgname-dev "

source="https://sources.openwrt.org/ubus-$pkgver~$_owrtgit.tar.zst"
builddir="$srcdir/ubus-$pkgver~$_owrtgit"

options="!check" ## need '-lasan -lubsan'

_luaversions="5.1 5.2"
for _v in $_luaversions; do
	makedepends="$makedepends lua$_v-dev"
	subpackages="$subpackages lua$_v-${pkgname#lua-}:_subpackage"
done

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		CMAKE_CROSSOPTS="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	## c lib & bin
	CFLAGS="$CFLAGS -fPIC -DPIC" cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DBUILD_STATIC=OFF \
		-DCMAKE_BUILD_TYPE=None \
		-DBUILD_LUA=OFF \
		-DBUILD_EXAMPLES=OFF \
		-DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
		$CMAKE_CROSSOPTS .
	cmake --build build

	## lua-ubus
	local lver; for lver in $_luaversions; do
		msg "==Building for Lua $lver... @ $PWD"
		CFLAGS="$CFLAGS -fPIC -DPIC" cmake -B "build-$lver" -G Ninja \
			-DCMAKE_INSTALL_PREFIX=/usr \
			-DCMAKE_INSTALL_LIBDIR=lib \
			-DBUILD_SHARED_LIBS=True \
			-DBUILD_STATIC=OFF \
			-DCMAKE_BUILD_TYPE=None \
			-DBUILD_LUA=ON \
			-DLUAPATH="$(pkg-config --variable=INSTALL_CMOD  "lua$lver")" \
			-DBUILD_EXAMPLES=OFF \
			-DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
			$CMAKE_CROSSOPTS .
		cmake --build "build-$lver" --target ubus_lua
	done
}


_subpackage() {
	## lua-ubus
	local lver="${subpkgname:3:3}"
	pkgdesc="OpenWrt RPC lib for Lua $lver"
	depends="lua$lver"
	install_if="$pkgname=$pkgver-r$pkgrel lua$lver"
	local rockdir="$subpkgdir/usr/lib/luarocks/rocks-$lver/$pkgname/$pkgver-1"

	msg "==Installing for Lua $lver... // $subpkgname @ $PWD"
	mkdir -p "$rockdir"
	echo 'rock_manifest = {}' > "$rockdir"/rock_manifest

	cd "$builddir"
	DESTDIR=$subpkgdir cmake --install build-$lver/lua -v
}

package() {
	## c lib & bin
	DESTDIR="$pkgdir" cmake --install build
}


sha512sums="
0d8b049907828ad46dd4f0931ed39d9b66d018819e2f90ea3f73d48df697ee40f9f0adb771e6a681f9c2de432236dda82b3547627d920971f93101ee0df30c52  ubus-2025.05.16~88e63250.tar.zst
"

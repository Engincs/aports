# Maintainer: Thomas Liske <thomas@fiasko-nw.net>
pkgname=pypy
pkgver=7.3.19
pkgrel=0
pkgdesc="A fast, compliant alternative implementation of Python 2.7"
url="https://www.pypy.org/"
arch="x86 x86_64 s390x aarch64 ppc64le"
license="MIT"
subpackages="$pkgname-dev $pkgname-tkinter"
provides="pypy-bootstrap"
provider_priority=100 # highest
makedepends="
	bzip2-dev
	expat-dev
	gdbm-dev
	libffi-dev
	linux-headers
	ncurses-dev
	openssl-dev>3
	perl
	py3-virtualenv
	pypy-bootstrap
	readline-dev
	rsync
	sqlite-dev
	tk-dev
	util-linux-misc
	xz-dev
	zlib-dev
	"
[ "$CARCH" = "x86" ] && options="textrels" # libpypy-c.so on x86 has textrels
source="https://downloads.python.org/pypy/pypy2.7-v$pkgver-src.tar.bz2
	libffi-shared.patch
	"
builddir="$srcdir"/pypy2.7-v$pkgver-src

case "$CARCH" in
x86_64)
	;;
*)
	# ignore failing tests on some archs for now
	options="$options !check"
	;;
esac

build() {
	if [ "$JOBS" -gt 16 ]; then
		export JOBS=16
	fi

	# translate with JIT
	pypy rpython/bin/rpython --opt=jit --shared --make-jobs $JOBS pypy/goal/targetpypystandalone

	# compile binary modules
	PYTHONPATH=. ./pypy-c lib_pypy/pypy_tools/build_cffi_imports.py
}

check() {
	./pypy-c -u pypy/test_all.py pypy/module/pypyjit/test_pypy_c
}

package() {
	install -Dm755 pypy-c libpypy-c.so -t "$pkgdir"/usr/lib/pypy/bin/

	rsync -r --exclude='__pycache__' --exclude='*.c' --exclude '*.o' lib_pypy/ "$pkgdir"/usr/lib/pypy/lib_pypy/

	rsync -r --exclude='__pycache__' --exclude='test' --exclude='tests' lib-python/ "$pkgdir"/usr/lib/pypy/lib-python/

	rsync -r --include='*.h' -f 'hide,! */' include/ "$pkgdir"/usr/lib/pypy/include/

	# Install symlinks
	mkdir -p "$pkgdir"/usr/bin "$pkgdir"/usr/lib
	ln -s ../lib/pypy/bin/pypy-c "$pkgdir"/usr/bin/pypy
	ln -s pypy/bin/libpypy-c.so "$pkgdir"/usr/lib/libpypy-c.so
}

dev() {
	default_dev

	# pyconfig.h is needed runtime so we move it back
	mkdir -p "$pkgdir"/usr/lib/pypy/include
	mv "$subpkgdir"/usr/lib/pypy/include/pyconfig.h \
		"$pkgdir"/usr/lib/pypy/include/
}

tkinter() {
	pkgdesc="Writing Tk applications with Pypy"

	amove \
		usr/lib/pypy/lib_pypy/_tkinter \
		usr/lib/pypy/lib-python/2.7/lib-tk \
		usr/lib/pypy/lib-python/2.7/idlelib
}

sha512sums="
8ab8d9c0fa94ec96ebfae30b7f97eb8dff6ad4ee17fa688df123927c45f3ffea2c7f5dbb98bd2f8a49f7db6baf0ba3e98fd230df0bdc8602e407fb2bc33144e3  pypy2.7-v7.3.19-src.tar.bz2
31388ec58a80edb9f4d6d2f939cc7d63a061cd8b23e4b4feca22b97fd8df4a0efa7eb22dfa98278b993a0b61d8ffe43ee687fc52e3a5ef50b6963b9a9bb26f48  libffi-shared.patch
"

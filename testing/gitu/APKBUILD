# Maintainer: Celeste <cielesti@protonmail.com>
maintainer="Celeste <cielesti@protonmail.com>"
pkgname=gitu
pkgver=0.35.0
pkgrel=0
pkgdesc="TUI Git client inspired by Magit"
url="https://github.com/altsem/gitu"
# s390x: nix crate, 32-bit: tests fail
arch="all !s390x !armhf !armv7 !x86"
license="MIT"
depends="git"
makedepends_build="cargo cargo-auditable"
makedepends_host="libgit2-dev"
subpackages="$pkgname-doc"
source="https://github.com/altsem/gitu/archive/refs/tags/v$pkgver/gitu-$pkgver.tar.gz
	nix-crate-loongarch64.patch
	"

# taken from main/rust/APKBUILD
_clear_vendor_checksums() {
	sed -i 's/\("files":{\)[^}]*/\1/' vendor/$1/.cargo-checksum.json
}

prepare() {
	mkdir -p .cargo
	cat >> .cargo/config.toml <<-EOF
		[source.crates-io]
		replace-with = "vendored-sources"

		[source.vendored-sources]
		directory = "vendor"
	EOF

	cargo vendor --locked
	_clear_vendor_checksums nix-0.26.4
	default_prepare
}

build() {
	cargo auditable build --frozen --release
}

check() {
	cargo test --frozen
}

package() {
	local targetdir="target/${CARGO_BUILD_TARGET:+$CARGO_BUILD_TARGET/}"

	install -Dvm755 $targetdir/release/gitu -t "$pkgdir"/usr/bin/

	install -Dvm644 README.md -t "$pkgdir"/usr/share/doc/$pkgname/
	install -Dvm644 LICENSE -t "$pkgdir"/usr/share/licenses/$pkgname/
}

sha512sums="
9bef7442bae65474fc236634df205106802fa7886053441a56f7a49c3a62b17cfa3e2135a365e182743c8a201136be0507c05a48bf0adc8f1906fc7ea64c71ef  gitu-0.35.0.tar.gz
8f7e31488f53ffd3810941a418d3a0a3d0093633dd34c849d6446ac4b9e494133b1865aa12eb5ae92f68eb85174d3fa68754b87769fd719cef92da5a506791c3  nix-crate-loongarch64.patch
"

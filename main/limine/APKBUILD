# Maintainer: streaksu <streaksu@ironclad-os.org>
pkgname=limine
pkgver=10.1.0
pkgrel=1
pkgdesc="Advanced, portable, multiprotocol bootloader"
url="https://limine-bootloader.org"
# armhf, armv7, and ppc64le do not have the required LLVM targets enabled
arch="all !armhf !armv7 !ppc64le"
license="BSD-2-Clause"
triggers="$pkgname-efi-updater.trigger=/usr/share/limine"
makedepends="
	clang
	lld
	llvm
	mtools
	nasm
	"
subpackages="
	$pkgname-dev
	$pkgname-doc
	$pkgname-efi-updater:efi_updater:noarch
	$pkgname-efi-aarch64:efi_aarch64:noarch
	$pkgname-efi-loongarch64:efi_loongarch64:noarch
	$pkgname-efi-riscv64:efi_riscv64:noarch
	$pkgname-efi-x86:efi_x86:noarch
	$pkgname-efi-x86_64:efi_x86_64:noarch
	$pkgname-bios::noarch
	$pkgname-bios-pxe:bios_pxe:noarch
	$pkgname-cd:_cd:noarch
	"
source="https://codeberg.org/Limine/Limine/releases/download/v$pkgver/limine-$pkgver.tar.gz
	limine-efi-updater.sh
	limine-efi-updater.conf
	"
options="!check" # no tests in tarball

build() {
	CFLAGS="$CFLAGS -flto=auto" \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--enable-all
	make
}

package() {
	make DESTDIR="$pkgdir" install

	install -Dm644 "$srcdir"/limine-efi-updater.conf -t "$pkgdir"/etc/limine/
	install -Dm755 "$srcdir"/limine-efi-updater.sh -t "$pkgdir"/usr/bin/
}

_cd() {
	pkgdesc="$pkgdesc (CD files)"
	depends="$pkgname=$pkgver-r$pkgrel $pkgname-bios=$pkgver-r$pkgrel"

	amove usr/share/limine/limine-*-cd.bin
}

bios_pxe() {
	pkgdesc="$pkgdesc (BIOS PXE executable)"
	depends="$pkgname=$pkgver-r$pkgrel $pkgname-bios=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-pxe=$pkgver-r$pkgrel"
	replaces="$pkgname-pxe"

	amove usr/share/limine/limine-bios-pxe.bin
}

bios() {
	pkgdesc="$pkgdesc (BIOS sys file)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-sys=$pkgver-r$pkgrel"
	replaces="$pkgname-sys"

	amove usr/share/limine/limine-bios.sys
}

efi_x86() {
	pkgdesc="$pkgdesc (IA-32 EFI image)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-x86=$pkgver-r$pkgrel"
	replaces="$pkgname-x86"

	amove usr/share/limine/BOOTIA32.EFI
}

efi_x86_64() {
	pkgdesc="$pkgdesc (x86-64 EFI image)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-x86_64=$pkgver-r$pkgrel"
	replaces="$pkgname-x86_64"

	amove usr/share/limine/BOOTX64.EFI
}

efi_aarch64() {
	pkgdesc="$pkgdesc (aarch64 EFI image)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-aarch64=$pkgver-r$pkgrel"
	replaces="$pkgname-aarch64"

	amove usr/share/limine/BOOTAA64.EFI
}

efi_riscv64() {
	pkgdesc="$pkgdesc (riscv64 EFI image)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-riscv64=$pkgver-r$pkgrel"
	replaces="$pkgname-riscv64"

	amove usr/share/limine/BOOTRISCV64.EFI
}

efi_loongarch64() {
	pkgdesc="$pkgdesc (loongarch64 EFI image)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-loongarch64=$pkgver-r$pkgrel"
	replaces="$pkgname-loongarch64"

	amove usr/share/limine/BOOTLOONGARCH64.EFI
}

efi_updater() {
	pkgdesc="Limine auto-updater for EFI payload"

	amove etc/limine/limine-efi-updater.conf
	amove usr/bin/limine-efi-updater.sh
}

sha512sums="
0f9038075dd16b7d7f0070004795ea1727a2995497d959775f76d4d5d0e56c55b63a4dcc0599175b852a4ae150a499c9919956351f78e1616af3fa955c7d05c4  limine-10.1.0.tar.gz
5d489bdf4457749852e22abcac6ad64a9e2f46f8c6b3874b27219ac32f48074fc52bed871703b648d6415fff00f8b7eb6109345a1d0ecd00efde11dc882c0b8f  limine-efi-updater.sh
2836c4ccaf650b8c8070c2c08e5254982f8f346a8b2a80d4d69d0c600ad29a4da77c1a6611ed01a69a143be41d0667a5ad0120f713c22281c070bcedd40a4b5b  limine-efi-updater.conf
"

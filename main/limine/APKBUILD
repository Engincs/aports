# Maintainer: streaksu <streaksu@ironclad-os.org>
pkgname=limine
pkgver=10.1.0
pkgrel=0
pkgdesc="Advanced, portable, multiprotocol bootloader"
url="https://limine-bootloader.org"
# armhf, armv7, and ppc64le do not have the required LLVM targets enabled
arch="all !armhf !armv7 !ppc64le"
license="BSD-2-Clause"
install="
	$pkgname-efi-updater.post-upgrade
	"
makedepends="
	clang
	lld
	llvm
	mtools
	nasm
	"
subpackages="
	$pkgname-dev
	$pkgname-doc
	$pkgname-efi-updater:efi_updater:noarch
	$pkgname-efi-aarch64:efi_aarch64:noarch
	$pkgname-efi-loongarch64:efi_loongarch64:noarch
	$pkgname-efi-riscv64:efi_riscv64:noarch
	$pkgname-efi-x86:efi_x86:noarch
	$pkgname-efi-x86_64:efi_x86_64:noarch
	$pkgname-bios::noarch
	$pkgname-bios-pxe:bios_pxe:noarch
	$pkgname-cd:_cd:noarch
	"
source="https://codeberg.org/Limine/Limine/releases/download/v$pkgver/limine-$pkgver.tar.gz
	limine-efi-updater.sh
	limine-efi.conf
	"
options="!check" # no tests in tarball

build() {
	CFLAGS="$CFLAGS -flto=auto" \
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--enable-all
	make
}

package() {
	make DESTDIR="$pkgdir" install

	install -Dm644 "$srcdir"/limine-efi.conf -t "$pkgdir"/etc/limine/
	install -Dm755 "$srcdir"/limine-efi-updater.sh -t "$pkgdir"/usr/bin/
}

_cd() {
	pkgdesc="$pkgdesc (CD files)"
	depends="$pkgname=$pkgver-r$pkgrel $pkgname-bios=$pkgver-r$pkgrel"

	amove usr/share/limine/limine-*-cd.bin
}

bios_pxe() {
	pkgdesc="$pkgdesc (BIOS PXE executable)"
	depends="$pkgname=$pkgver-r$pkgrel $pkgname-bios=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-pxe=$pkgver-r$pkgrel"
	replaces="$pkgname-pxe"

	amove usr/share/limine/limine-bios-pxe.bin
}

bios() {
	pkgdesc="$pkgdesc (BIOS sys file)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-sys=$pkgver-r$pkgrel"
	replaces="$pkgname-sys"

	amove usr/share/limine/limine-bios.sys
}

efi_x86() {
	pkgdesc="$pkgdesc (IA-32 EFI image)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-x86=$pkgver-r$pkgrel"
	replaces="$pkgname-x86"

	amove usr/share/limine/BOOTIA32.EFI
}

efi_x86_64() {
	pkgdesc="$pkgdesc (x86-64 EFI image)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-x86_64=$pkgver-r$pkgrel"
	replaces="$pkgname-x86_64"

	amove usr/share/limine/BOOTX64.EFI
}

efi_aarch64() {
	pkgdesc="$pkgdesc (aarch64 EFI image)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-aarch64=$pkgver-r$pkgrel"
	replaces="$pkgname-aarch64"

	amove usr/share/limine/BOOTAA64.EFI
}

efi_riscv64() {
	pkgdesc="$pkgdesc (riscv64 EFI image)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-riscv64=$pkgver-r$pkgrel"
	replaces="$pkgname-riscv64"

	amove usr/share/limine/BOOTRISCV64.EFI
}

efi_loongarch64() {
	pkgdesc="$pkgdesc (loongarch64 EFI image)"
	depends="$pkgname=$pkgver-r$pkgrel"

	# renamed to be less vague
	provides="$pkgname-loongarch64=$pkgver-r$pkgrel"
	replaces="$pkgname-loongarch64"

	amove usr/share/limine/BOOTLOONGARCH64.EFI
}

efi_updater() {
	pkgdesc="Limine auto-updater for EFI payload"

	amove etc/limine/limine-efi.conf
	amove usr/bin/limine-efi-updater.sh
}

sha512sums="
0f9038075dd16b7d7f0070004795ea1727a2995497d959775f76d4d5d0e56c55b63a4dcc0599175b852a4ae150a499c9919956351f78e1616af3fa955c7d05c4  limine-10.1.0.tar.gz
6439053abb4ebc4a2f8ec5503c29b9d28d4f901e76745385423c8601588a91a5ecf7dc0484b564d5933c76f89fa1a889c0bd207ee6033ba6b9b20a67c5eb557f  limine-efi-updater.sh
394c5067b850eb7b8b236c172471c6b9d152a4ef823d2f6b71396199fbe798638ef4031e60402fdfdfc9425aed0b7e119d15625fc0007622d35fbfadf9457cf8  limine-efi.conf
"
